const Discord = require('discord.js');
const client = new Discord.Client();
const token = "NjExOTEyNjMxNzk1NzEyMDAw.XVauDA.GBKqcqOPSN6RBcc9PYZOeDADorc";
const clientMention = "<@!611912631795712000>";

client.on('ready', () => {
    console.log("Connected as " + client.user.tag)
});


client.on('message', (messageListened)=>{
    if(messageListened.author == client.user){
        return;
    }

    tagged = isAsked(clientMention, messageListened);
    if (messageListened.content.startsWith("§") || tagged){
        commandProcess(messageListened, tagged);
    }
});

function commandProcess(messageListened, tagged){
    let command = messageListened.content;
    if(!tagged){
        command = command.substr(1);
    }
    let splittedCommand = command.split(" ");
    let firstCommand = splittedCommand[0];
    if(tagged){
        firstCommand = splittedCommand[1];
    }
    let numberCommand = splittedCommand.slice(1);

    if(firstCommand === "help"){
        messageListened.author.send("```Pour intéragir avec le bot, mentionnez-le puis faites la commande, ou utilisez le préfixe § \n"
        + "Commandes : \n"
        + "help    :: Vous donne la page d'aide\n"
        + "edt     :: Donne le site des emplois du temps\n"
        + "next    :: /! WIP !\\ Vous donne votre prochain cours /! WIP !\\\n"
        + "current :: /! WIP !\\ Donne le lien de l'edt actuel   /! WIP !\\```");
    }
    else if(firstCommand === "edt"){
        messageListened.channel.send("Le site des edt : http://edt-iut-info.unilim.fr/edt/A1/");
    }
    else if(firstCommand === "status"){
        messageListened.channel.send("```Etat du bot :\n"
        +"Est en fonctionnement depuis : " + Math.floor(client.uptime/1000/60/60) + "h" + Math.floor(client.uptime/1000/60%60) + "m" + Math.floor(client.uptime/1000%60%60) + "s" + "\n"
        +"Latence : " + client.ws.ping + "ms\n"
        +"Mémoire : " + Math.round(process.memoryUsage().heapUsed/1024/1024*100)/100 + "mb```");
    }
    // else if(firstCommand === "fullClear"){
    //     let nbMessages
    //     channel.messages.fetch({})
    //     .then(messages => nbMessages = messages.size)
    //     .catch(console.error);
    //     do{
    //         messageListened.channel.bulkDelete(1);
    //         nbMessages--;
    //         console.log("Deleting...");
    //     }while(nbMessages > 0);
    // }
    else{
        messageListened.channel.send("T'abuse gros, utilise §help tu m'a cassé la tête (même si j'en ai pas)");
    }
}

function isAsked(Person, messageListened){
    for(i=0; i < Person.length;i++){
        if(messageListened.content[i] != Person[i]){
            return false;
        }
    }
    return true;
}

client.login(token) ;